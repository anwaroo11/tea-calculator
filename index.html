<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <link rel="apple-touch-icon" href="icon.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>حاسبة الشاي</title>

  <!-- Lucide icons (outline) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial; }
    body { margin: 0; background:#0b1220; color:#e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    .card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      padding: 18px;
      backdrop-filter: blur(8px);
    }
    h1 { margin: 0 0 8px; font-size: 22px; }
    p.sub { margin: 0 0 18px; opacity: .85; }

    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 780px){ .grid { grid-template-columns: 1fr 1fr; } }

    label { font-size: 13px; opacity: .9; display:block; margin-bottom: 6px; }
    select, input {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.25);
      color: #e9eefc;
      outline: none;
      font-size: 15px;
      box-sizing: border-box;
      height: 48px;
    }
    input[type=number] { appearance: textfield; -moz-appearance: textfield; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    /* حل وضوح القوائم على الكمبيوتر */
    select option { color:#111; background:#fff; }
    input::placeholder { opacity: .6; }

    .out {
      margin-top: 14px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 14px;
      line-height: 1.8;
    }

    .kpi { display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width: 780px){ .kpi { grid-template-columns: 1fr 1fr; } }
    @media (min-width: 1024px){ .kpi { grid-template-columns: 1fr 1fr 1fr 1fr; } }

    .box {
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .muted { opacity: .75; font-size: 12px; margin-top: 4px; display:flex; align-items:center; gap:8px; }
    .muted2 { opacity: .75; font-size: 12px; margin-top: 6px; }
    .big { font-size: 18px; font-weight: 700; margin-top: 6px; }
    .note { margin-top: 10px; font-size: 12px; opacity:.80; }

    .actions { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .actionBtn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: #e9eefc;
      font-size: 14px;
      cursor: pointer;
    }
    .actionBtn:hover { background: rgba(255,255,255,0.15); }

    /* lucide icon sizing */
    .muted svg { width:16px; height:16px; stroke-width:1.7; opacity:0.9; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>حاسبة الشاي ☕</h1>
      <p class="sub">اختر الشاي، وحط كمية الماء بالمل… وتطلع لك وزنية الشاي + السكر حسب المذاق + مدة الخدرة + كم بيالة تكفي.</p>

      <div class="grid">
        <div>
          <label>بحث عن الشاي</label>
          <input id="teaSearch" type="text" placeholder="اكتب اسم الشاي أو نوع الورق..." />
          <div class="muted2">مثال: المنيس — نهرين — OP1</div>

          <label style="margin-top:10px;">اختر الشاي</label>
          <select id="teaSelect"></select>
        </div>

        <!-- يظهر فقط لو الشاي له تصنيفات (مثل المنيس) -->
        <div id="typeWrap" style="display:none;">
          <label>نوع الورق</label>
          <select id="typeSelect"></select>
          <div class="muted2">يظهر فقط للبراند اللي له أكثر من نوع</div>
        </div>

        <div>
          <label>كمية الماء (مل)</label>
          <input id="waterMl" type="number" inputmode="decimal" min="1" value="1000" />
          <div class="muted2">مثال: 500 أو 750 أو 1000</div>
        </div>

        <div>
          <label>المذاق</label>
          <select id="taste">
            <option value="normal" selected>مناسب</option>
            <option value="heavy">ثقيل</option>
            <option value="nosugar">بدون سكر</option>
          </select>
          <div class="muted2" id="tasteHint"></div>
        </div>
      </div>

      <div class="out" id="output" aria-live="polite"></div>
    </div>
  </div>

<script>
/* =========================
   ✅ وين تضيف الشاي؟
   1) شاي عادي (بدون تصنيفات):
      - ضيفه داخل SIMPLE_TEAS تحت

   2) شاي بتصنيفات (مثل المنيس OP1/BOP1...):
      - ضيفه داخل BRANDED_TEAS
   ========================= */

/* ---------- (A) الشاي العادي (بدون تصنيفات إضافية) ---------- */
const SIMPLE_TEAS = [
  {
    id: "nahrain-op",
    teaType: "OP",
    brand: "شاي النهرين",
    teaPerLiter:   { min: 12, max: 12 },
    sugarPerLiter: { min: 50, max: 55 },
    steepMinutes:  { min: 20, max: 25 }
  },
  {
    id: "naif-op1",
    teaType: "OP1",
    brand: "شاي نايف",
    teaPerLiter:   { min: 14, max: 14 },
    sugarPerLiter: { min: 50, max: 55 },
    steepMinutes:  { min: 30, max: 35 }
  }
];

/* ---------- (B) شاي بتصنيفات (البراند الواحد له عدة أنواع) ---------- */
const BRANDED_TEAS = [
  {
    brandId: "munais",
    brand: "شاي المنيس",
    items: [
      {
        id: "munais-op1",
        teaType: "OP1",
        // ✅ حسب طلبك (لكل 1 لتر)
        teaPerLiterByTaste: { normal: 12.5, heavy: 13.5, nosugar: 11.5 },
        // السكر: عدّلها إذا عندك قيم مختلفة للمنيس
        sugarPerLiter: { min: 50, max: 55 },
        // الخدرة 25-30
        steepMinutes: { min: 25, max: 30 }
      }
    ]
  }
];

/* افتراض البيالة */
const CUP_ML = 100;

/* ===== Helpers ===== */
function smartNumber(n){
  if (!Number.isFinite(n)) return "-";
  const isInt = Math.abs(n - Math.round(n)) < 1e-9;
  return isInt ? String(Math.round(n)) : n.toFixed(1);
}
function toLitersFromMl(ml){
  const v = Number(ml);
  if (!Number.isFinite(v) || v <= 0) return NaN;
  return v / 1000;
}
function minutesText(r){
  if (r.min === r.max) return `${r.min} دقيقة`;
  return `${r.min} – ${r.max} دقيقة`;
}
function pickRangeByTaste(range, taste){
  if (taste === "heavy") return range.max;
  return range.min; // مناسب + بدون سكر => الأقل
}
function tasteLabel(v){
  if (v === "heavy") return "ثقيل";
  if (v === "nosugar") return "بدون سكر";
  return "مناسب";
}

/* ===== UI ===== */
const teaSearch  = document.getElementById("teaSearch");
const teaSelect  = document.getElementById("teaSelect");
const typeWrap   = document.getElementById("typeWrap");
const typeSelect = document.getElementById("typeSelect");
const waterMlInp = document.getElementById("waterMl");
const tasteSel   = document.getElementById("taste");
const tasteHint  = document.getElementById("tasteHint");
const output     = document.getElementById("output");

/* تعبئة القائمة الرئيسية (مع فلترة البحث) */
function populateMainSelect(filterText = "") {
  const q = (filterText || "").trim().toLowerCase();
  const current = teaSelect.value;

  teaSelect.innerHTML = "";

  // الشاي العادي
  SIMPLE_TEAS.forEach(t => {
    const label = `${t.brand} — ${t.teaType}`.toLowerCase();
    if (q && !label.includes(q)) return;

    const opt = document.createElement("option");
    opt.value = `simple:${t.id}`;
    opt.textContent = `${t.brand} — ${t.teaType}`;
    teaSelect.appendChild(opt);
  });

  // البراندات اللي لها تصنيفات (مثل المنيس)
  BRANDED_TEAS.forEach(b => {
    const brandLabel = `${b.brand}`.toLowerCase();
    const typesLabel = b.items.map(x => x.teaType).join(" ").toLowerCase();
    const match = !q || brandLabel.includes(q) || typesLabel.includes(q);
    if (!match) return;

    const opt = document.createElement("option");
    opt.value = `brand:${b.brandId}`;
    opt.textContent = `${b.brand}`;
    teaSelect.appendChild(opt);
  });

  // حاول ترجع نفس الاختيار السابق إذا ما زال موجود
  const stillExists = Array.from(teaSelect.options).some(o => o.value === current);
  if (stillExists) {
    teaSelect.value = current;
  } else if (teaSelect.options.length) {
    teaSelect.value = teaSelect.options[0].value;
  }
}

function getSelectedTeaObject(){
  const val = teaSelect.value || "";
  const taste = tasteSel.value;

  // شاي عادي
  if (val.startsWith("simple:")) {
    const id = val.replace("simple:", "");
    const tea = SIMPLE_TEAS.find(x => x.id === id) || SIMPLE_TEAS[0];

    typeWrap.style.display = "none";

    const teaPerLiterPicked = pickRangeByTaste(tea.teaPerLiter, taste);
    return {
      brandLabel: tea.brand,
      teaType: tea.teaType,
      teaPerLiterPicked,
      sugarPerLiterPicked: (taste === "nosugar") ? 0 : pickRangeByTaste(tea.sugarPerLiter, taste),
      steepMinutes: tea.steepMinutes,
      hintText: `لكل 1 لتر: مناسب (شاي ${smartNumber(tea.teaPerLiter.min)} • سكر ${smartNumber(tea.sugarPerLiter.min)}) — ثقيل (شاي ${smartNumber(tea.teaPerLiter.max)} • سكر ${smartNumber(tea.sugarPerLiter.max)})`
    };
  }

  // براند بتصنيفات
  if (val.startsWith("brand:")) {
    const brandId = val.replace("brand:", "");
    const brand = BRANDED_TEAS.find(b => b.brandId === brandId) || BRANDED_TEAS[0];

    typeWrap.style.display = "block";

    // عبي الأنواع إذا فاضية أو لو تغير البراند
    const existingIds = Array.from(typeSelect.options).map(o => o.value);
    const shouldRebuild = existingIds.length !== brand.items.length ||
      (existingIds[0] && !brand.items.some(it => it.id === existingIds[0]));

    if (shouldRebuild) {
      typeSelect.innerHTML = "";
      brand.items.forEach(it => {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.teaType;
        typeSelect.appendChild(opt);
      });
      typeSelect.value = brand.items[0].id;
    }

    const selectedItem = brand.items.find(it => it.id === typeSelect.value) || brand.items[0];

    const teaPerLiterPicked = selectedItem.teaPerLiterByTaste
      ? Number(selectedItem.teaPerLiterByTaste[taste])
      : pickRangeByTaste(selectedItem.teaPerLiter, taste);

    const sugarPerLiterPicked = (taste === "nosugar") ? 0 : pickRangeByTaste(selectedItem.sugarPerLiter, taste);

    const hint = selectedItem.teaPerLiterByTaste
      ? `لكل 1 لتر: مناسب (شاي ${smartNumber(selectedItem.teaPerLiterByTaste.normal)} • سكر ${smartNumber(selectedItem.sugarPerLiter.min)}) — ثقيل (شاي ${smartNumber(selectedItem.teaPerLiterByTaste.heavy)} • سكر ${smartNumber(selectedItem.sugarPerLiter.max)}) — بدون سكر (شاي ${smartNumber(selectedItem.teaPerLiterByTaste.nosugar)} • سكر 0)`
      : `لكل 1 لتر: مناسب (شاي ${smartNumber(selectedItem.teaPerLiter.min)} • سكر ${smartNumber(selectedItem.sugarPerLiter.min)}) — ثقيل (شاي ${smartNumber(selectedItem.teaPerLiter.max)} • سكر ${smartNumber(selectedItem.sugarPerLiter.max)})`;

    return {
      brandLabel: brand.brand,
      teaType: selectedItem.teaType,
      teaPerLiterPicked,
      sugarPerLiterPicked,
      steepMinutes: selectedItem.steepMinutes,
      hintText: hint
    };
  }

  // fallback
  typeWrap.style.display = "none";
  const t = SIMPLE_TEAS[0];
  return {
    brandLabel: t.brand,
    teaType: t.teaType,
    teaPerLiterPicked: pickRangeByTaste(t.teaPerLiter, tasteSel.value),
    sugarPerLiterPicked: (tasteSel.value === "nosugar") ? 0 : pickRangeByTaste(t.sugarPerLiter, tasteSel.value),
    steepMinutes: t.steepMinutes,
    hintText: ""
  };
}

function getResultText(){
  const liters = toLitersFromMl(waterMlInp.value);
  if (!Number.isFinite(liters)) return "";

  const teaObj = getSelectedTeaObject();
  const tasteText = tasteLabel(tasteSel.value);

  const teaGrams = smartNumber(teaObj.teaPerLiterPicked * liters);
  const sugarText = teaObj.sugarPerLiterPicked === 0 ? "بدون سكر" : (smartNumber(teaObj.sugarPerLiterPicked * liters) + " جم");

  const cups = Number(waterMlInp.value) / CUP_ML;

  return `
شاي ${teaObj.brandLabel} — ${teaObj.teaType}
الماء: ${waterMlInp.value} مل
المذاق: ${tasteText}

وزن الشاي: ${teaGrams} جم
السكر: ${sugarText}
مدة الخدرة: ${minutesText(teaObj.steepMinutes)}
كم بيالة تقريباً: ${smartNumber(cups)}
`.trim();
}

function bindActionButtons(){
  const copyBtn = document.getElementById("copyBtn");
  const waBtn = document.getElementById("waBtn");

  if (copyBtn) {
    copyBtn.onclick = async () => {
      const text = getResultText();
      if (!text) return;

      try {
        await navigator.clipboard.writeText(text);
      } catch (e) {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }

      copyBtn.textContent = "تم النسخ ✓";
      setTimeout(() => copyBtn.textContent = "نسخ النتيجة", 1500);
    };
  }

  if (waBtn) {
    waBtn.onclick = () => {
      const text = encodeURIComponent(getResultText());
      if (!text) return;
      window.location.href = `https://wa.me/?text=${text}`;
    };
  }
}

function render(){
  try {
    const liters = toLitersFromMl(waterMlInp.value);
    if (!Number.isFinite(liters)) {
      output.innerHTML = `⚠️ دخل كمية ماء صحيحة بالمل.`;
      return;
    }

    const teaObj = getSelectedTeaObject();
    const taste = tasteSel.value;

    tasteHint.textContent = teaObj.hintText;

    const teaGrams = teaObj.teaPerLiterPicked * liters;
    const sugarGrams = teaObj.sugarPerLiterPicked === 0 ? 0 : (teaObj.sugarPerLiterPicked * liters);

    const waterMl = Number(waterMlInp.value);
    const cups = (Number.isFinite(waterMl) && waterMl > 0) ? (waterMl / CUP_ML) : NaN;

    const sugarText = (teaObj.sugarPerLiterPicked === 0) ? "بدون سكر" : `${smartNumber(sugarGrams)} جم`;

    output.innerHTML = `
      <div class="kpi">
        <div class="box">
          <div class="muted"><i data-lucide="scale"></i> وزن الشاي المطلوب</div>
          <div class="big">${smartNumber(teaGrams)} جم</div>
          <div class="muted2">${tasteLabel(taste)} • لكل لتر: ${smartNumber(teaObj.teaPerLiterPicked)} جم</div>
        </div>

        <div class="box">
          <div class="muted"><i data-lucide="candy"></i> السكر</div>
          <div class="big">${sugarText}</div>
          <div class="muted2">${taste === "nosugar" ? "بدون سكر" : `لكل لتر: ${smartNumber(teaObj.sugarPerLiterPicked)} جم`}</div>
        </div>

        <div class="box">
          <div class="muted"><i data-lucide="clock"></i> مدة الخدرة</div>
          <div class="big">${minutesText(teaObj.steepMinutes)}</div>
        </div>

        <div class="box">
          <div class="muted"><i data-lucide="coffee"></i> كم بيالة تكفي (تقريباً)</div>
          <div class="big">${smartNumber(cups)}</div>
          <div class="muted2">حجم البيالة الواحدة تقريبًا ١٠٠ مل</div>
        </div>
      </div>

      <div class="actions">
        <button id="copyBtn" class="actionBtn">نسخ النتيجة</button>
        <button id="waBtn" class="actionBtn">مشاركة واتساب</button>
      </div>

      <div class="note">
        <b>المنتج:</b> ${teaObj.brandLabel} — ${teaObj.teaType}<br/>
        <b>المذاق:</b> ${tasteLabel(taste)}<br/>
        <b>الماء:</b> ${waterMlInp.value} مل
      </div>
    `;

    if (window.lucide) lucide.createIcons();
    bindActionButtons();
  } catch (e) {
    output.innerHTML = `
      <div style="padding:12px;border-radius:12px;border:1px solid rgba(255,80,80,.35);background:rgba(255,80,80,.10)">
        ⚠️ صار خطأ في بيانات الشاي (قوس/فاصلة/قيمة).
        <div style="opacity:.8;font-size:12px;margin-top:6px">تفاصيل: ${String(e.message || e)}</div>
      </div>
    `;
  }
}

/* events */
teaSearch.addEventListener("input", () => {
  populateMainSelect(teaSearch.value);
  render();
});

teaSelect.addEventListener("change", render);
typeSelect.addEventListener("change", render);
waterMlInp.addEventListener("input", render);
tasteSel.addEventListener("change", render);

/* init */
populateMainSelect("");
render();
</script>
</body>
</html>
