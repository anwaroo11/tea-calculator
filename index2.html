<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <link rel="apple-touch-icon" href="icon.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø´Ø§ÙŠ</title>

  <!-- Lucide icons (outline) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ========================================
       COLOR PALETTE: Warm Beige + Cocoa + Dark Slate
       ======================================== */
    :root {
      --bg-primary: #faf7f2;
      --bg-secondary: #f3ede5;
      --card-bg: #ffffff;
      --card-shadow: 0 2px 12px rgba(60, 45, 32, 0.08);
      --card-shadow-hover: 0 4px 20px rgba(60, 45, 32, 0.12);
      --border-light: #ede5dc;
      --border-medium: #d9ccbf;
      --text-primary: #3c2d20;
      --text-secondary: #6b5b4f;
      --text-muted: #9d8b7d;
      --accent-tea: #7d6e4e;
      --accent-tea-light: #a89766;
      --input-bg: #fefdfb;
      --input-border: #e8dfd5;
      --input-focus: #d9a574;
      --error-bg: #ffe8e0;
      --error-text: #a83d2f;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root { 
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial; 
    }

    body { 
      margin: 0; 
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      padding: 20px;
      min-height: 100vh;
    }

    .wrap { 
      max-width: 900px; 
      margin: 0 auto;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-light);
      border-radius: 24px;
      padding: 28px;
      box-shadow: var(--card-shadow);
      transition: box-shadow 0.3s ease;
    }

    .card:hover {
      box-shadow: var(--card-shadow-hover);
    }

    h1 { 
      margin: 0 0 12px; 
      font-size: 32px; 
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    p.sub { 
      margin: 0 0 28px; 
      opacity: 0.85; 
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .grid { 
      display: grid; 
      gap: 16px; 
      grid-template-columns: 1fr; 
      margin-bottom: 24px;
    }

    @media (min-width: 640px) {
      .grid { 
        grid-template-columns: 1fr 1fr; 
      }
    }

    @media (min-width: 900px) {
      .grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 14px;
      }
    }

    label { 
      font-size: 12px; 
      opacity: 0.9; 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    select, input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1.5px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      font-size: 15px;
      box-sizing: border-box;
      height: 44px;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    select:hover, input:hover {
      border-color: var(--accent-tea-light);
      background: #fffbf7;
    }

    select:focus, input:focus {
      border-color: var(--input-focus);
      background: #fffbf7;
      box-shadow: 0 0 0 3px rgba(217, 165, 116, 0.1);
    }

    input[type=number] { 
      appearance: textfield; 
      -moz-appearance: textfield; 
    }

    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }

    /* ğŸ”§ Fix: Dark text on light dropdown for desktop readability */
    select option { 
      color: var(--text-primary); 
      background: var(--card-bg);
      padding: 8px 12px;
    }

    select option:checked {
      background: linear-gradient(var(--input-focus), var(--input-focus));
      color: white;
    }

    input::placeholder { 
      opacity: 0.6; 
      color: var(--text-muted);
    }

    .muted2 { 
      opacity: 0.75; 
      font-size: 11px; 
      margin-top: 5px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .out {
      margin-top: 28px;
    }

    .kpi { 
      display: grid; 
      gap: 12px; 
      grid-template-columns: 1fr; 
      margin-bottom: 16px;
    }

    @media (min-width: 640px) {
      .kpi { 
        grid-template-columns: 1fr 1fr; 
      }
    }

    @media (min-width: 900px) {
      .kpi { 
        grid-template-columns: repeat(4, 1fr); 
      }
    }

    .box {
      padding: 16px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, #f8f2eb 100%);
      border: 1px solid var(--border-light);
      transition: all 0.2s ease;
    }

    .box:hover {
      background: linear-gradient(135deg, #f0e8e0 0%, #ede5dc 100%);
      border-color: var(--accent-tea-light);
    }

    .muted { 
      opacity: 0.85; 
      font-size: 11px; 
      margin-bottom: 6px; 
      display: flex; 
      align-items: center; 
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--text-secondary);
    }

    .muted svg { 
      width: 14px; 
      height: 14px; 
      stroke-width: 1.8; 
      opacity: 0.9;
      color: var(--accent-tea);
    }

    .big { 
      font-size: 24px; 
      font-weight: 700; 
      margin-top: 4px;
      color: var(--accent-tea);
      letter-spacing: -0.5px;
    }

    .note { 
      margin-top: 16px; 
      padding: 12px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, #f8f2eb 100%);
      border: 1px solid var(--border-light);
      font-size: 12px; 
      opacity: 0.85;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    .note b {
      font-weight: 600;
      color: var(--text-primary);
    }

    .actions { 
      display: flex; 
      gap: 10px; 
      margin-top: 16px; 
      flex-wrap: wrap; 
    }

    .actionBtn {
      flex: 1;
      min-width: 140px;
      padding: 11px 16px;
      border-radius: 10px;
      border: 1.5px solid var(--border-medium);
      background: linear-gradient(135deg, var(--accent-tea) 0%, #8b7c5a 100%);
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .actionBtn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(125, 110, 78, 0.25);
      border-color: var(--accent-tea);
    }

    .actionBtn:active {
      transform: translateY(0);
    }

    .actionBtn svg {
      width: 14px;
      height: 14px;
      stroke-width: 2;
    }

    /* Error Panel */
    .error-panel {
      padding: 14px;
      border-radius: 12px;
      border: 1.5px solid #d9a574;
      background: var(--error-bg);
      color: var(--error-text);
      font-size: 14px;
      line-height: 1.5;
    }

    /* Conditional visibility */
    #typeWrap {
      display: none;
    }

    /* Responsive adjustments */
    @media (max-width: 640px) {
      h1 {
        font-size: 26px;
      }

      .card {
        padding: 20px;
        border-radius: 20px;
      }

      label {
        font-size: 11px;
      }

      .big {
        font-size: 20px;
      }

      .actionBtn {
        padding: 10px 12px;
        font-size: 12px;
      }
    }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø´Ø§ÙŠ â˜•</h1>
      <p class="sub">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø§ÙŠØŒ ÙˆØ­Ø· ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø§Ø¡ Ø¨Ø§Ù„Ù…Ù„â€¦ ÙˆØªØ·Ù„Ø¹ Ù„Ùƒ ÙˆØ²Ù†ÙŠØ© Ø§Ù„Ø´Ø§ÙŠ + Ø§Ù„Ø³ÙƒØ± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø°Ø§Ù‚ + Ù…Ø¯Ø© Ø§Ù„Ø®Ø¯Ø±Ø© + ÙƒÙ… Ø¨ÙŠØ§Ù„Ø© ØªÙƒÙÙŠ.</p>

      <div class="grid">
        <div>
          <label>Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø§ÙŠ</label>
          <input id="teaSearch" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø§ÙŠ Ø£Ùˆ Ù†ÙˆØ¹ Ø§Ù„ÙˆØ±Ù‚..." />
          <div class="muted2">Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ù†ÙŠØ³ â€” Ù†Ù‡Ø±ÙŠÙ† â€” OP1</div>

          <label style="margin-top:10px;">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø§ÙŠ</label>
          <select id="teaSelect"></select>
        </div>

        <!-- ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ø´Ø§ÙŠ Ù„Ù‡ ØªØµÙ†ÙŠÙØ§Øª (Ù…Ø«Ù„ Ø§Ù„Ù…Ù†ÙŠØ³) -->
        <div id="typeWrap">
          <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ±Ù‚</label>
          <select id="typeSelect"></select>
          <div class="muted2">ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø¨Ø±Ø§Ù†Ø¯ Ø§Ù„Ù„ÙŠ Ù„Ù‡ Ø£ÙƒØ«Ø± Ù…Ù† Ù†ÙˆØ¹</div>
        </div>

        <div>
          <label>ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø§Ø¡ (Ù…Ù„)</label>
          <input id="waterMl" type="number" inputmode="decimal" min="1" value="1000" />
          <div class="muted2">Ù…Ø«Ø§Ù„: 500 Ø£Ùˆ 750 Ø£Ùˆ 1000</div>
        </div>

        <div>
          <label>Ø§Ù„Ù…Ø°Ø§Ù‚</label>
          <select id="taste">
            <option value="normal" selected>Ù…Ù†Ø§Ø³Ø¨</option>
            <option value="heavy">Ø«Ù‚ÙŠÙ„</option>
            <option value="nosugar">Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±</option>
          </select>
          <div class="muted2" id="tasteHint"></div>
        </div>
      </div>

      <div class="out" id="output" aria-live="polite"></div>
    </div>
  </div>

<script>
/* =========================
   âœ… ÙˆÙŠÙ† ØªØ¶ÙŠÙ Ø§Ù„Ø´Ø§ÙŠØŸ
   1) Ø´Ø§ÙŠ Ø¹Ø§Ø¯ÙŠ (Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙØ§Øª):
      - Ø¶ÙŠÙÙ‡ Ø¯Ø§Ø®Ù„ SIMPLE_TEAS ØªØ­Øª

   2) Ø´Ø§ÙŠ Ø¨ØªØµÙ†ÙŠÙØ§Øª (Ù…Ø«Ù„ Ø§Ù„Ù…Ù†ÙŠØ³ OP1/BOP1...):
      - Ø¶ÙŠÙÙ‡ Ø¯Ø§Ø®Ù„ BRANDED_TEAS
   ========================= */

/* ---------- (A) Ø§Ù„Ø´Ø§ÙŠ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©) ---------- */
const SIMPLE_TEAS = [
  {
    id: "nahrain-op",
    teaType: "OP",
    brand: "Ø´Ø§ÙŠ Ø§Ù„Ù†Ù‡Ø±ÙŠÙ†",
    teaPerLiter:   { min: 12, max: 12 },
    sugarPerLiter: { min: 50, max: 55 },
    steepMinutes:  { min: 20, max: 25 }
  },
  {
    id: "naif-op1",
    teaType: "OP1",
    brand: "Ø´Ø§ÙŠ Ù†Ø§ÙŠÙ",
    teaPerLiter:   { min: 14, max: 14 },
    sugarPerLiter: { min: 50, max: 55 },
    steepMinutes:  { min: 30, max: 35 }
  }
];

/* ---------- (B) Ø´Ø§ÙŠ Ø¨ØªØµÙ†ÙŠÙØ§Øª (Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯ Ø§Ù„ÙˆØ§Ø­Ø¯ Ù„Ù‡ Ø¹Ø¯Ø© Ø£Ù†ÙˆØ§Ø¹) ---------- */
const BRANDED_TEAS = [
  {
    brandId: "munais",
    brand: "Ø´Ø§ÙŠ Ø§Ù„Ù…Ù†ÙŠØ³",
    items: [
      {
        id: "munais-op1",
        teaType: "OP1",
        // âœ… Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ (Ù„ÙƒÙ„ 1 Ù„ØªØ±)
        teaPerLiterByTaste: { normal: 12.5, heavy: 13.5, nosugar: 11.5 },
        // Ø§Ù„Ø³ÙƒØ±: Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ù‚ÙŠÙ… Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ù…Ù†ÙŠØ³
        sugarPerLiter: { min: 50, max: 55 },
        // Ø§Ù„Ø®Ø¯Ø±Ø© 25-30
        steepMinutes: { min: 25, max: 30 }
      }
    ]
  }
];

/* Ø§ÙØªØ±Ø§Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù„Ø© */
const CUP_ML = 100;

/* ===== Helpers ===== */
function smartNumber(n){
  if (!Number.isFinite(n)) return "-";
  const isInt = Math.abs(n - Math.round(n)) < 1e-9;
  return isInt ? String(Math.round(n)) : n.toFixed(1);
}
function toLitersFromMl(ml){
  const v = Number(ml);
  if (!Number.isFinite(v) || v <= 0) return NaN;
  return v / 1000;
}
function minutesText(r){
  if (r.min === r.max) return `${r.min} Ø¯Ù‚ÙŠÙ‚Ø©`;
  return `${r.min} â€“ ${r.max} Ø¯Ù‚ÙŠÙ‚Ø©`;
}
function pickRangeByTaste(range, taste){
  if (taste === "heavy") return range.max;
  return range.min; // Ù…Ù†Ø§Ø³Ø¨ + Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ± => Ø§Ù„Ø£Ù‚Ù„
}
function tasteLabel(v){
  if (v === "heavy") return "Ø«Ù‚ÙŠÙ„";
  if (v === "nosugar") return "Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±";
  return "Ù…Ù†Ø§Ø³Ø¨";
}

/* ===== UI ===== */
const teaSearch  = document.getElementById("teaSearch");
const teaSelect  = document.getElementById("teaSelect");
const typeWrap   = document.getElementById("typeWrap");
const typeSelect = document.getElementById("typeSelect");
const waterMlInp = document.getElementById("waterMl");
const tasteSel   = document.getElementById("taste");
const tasteHint  = document.getElementById("tasteHint");
const output     = document.getElementById("output");

/* ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù…Ø¹ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø«) */
function populateMainSelect(filterText = "") {
  const q = (filterText || "").trim().toLowerCase();
  const current = teaSelect.value;

  teaSelect.innerHTML = "";

  // Ø§Ù„Ø´Ø§ÙŠ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
  SIMPLE_TEAS.forEach(t => {
    const label = `${t.brand} â€” ${t.teaType}`.toLowerCase();
    if (q && !label.includes(q)) return;

    const opt = document.createElement("option");
    opt.value = `simple:${t.id}`;
    opt.textContent = `${t.brand} â€” ${t.teaType}`;
    teaSelect.appendChild(opt);
  });

  // Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯Ø§Øª Ø§Ù„Ù„ÙŠ Ù„Ù‡Ø§ ØªØµÙ†ÙŠÙØ§Øª (Ù…Ø«Ù„ Ø§Ù„Ù…Ù†ÙŠØ³)
  BRANDED_TEAS.forEach(b => {
    const brandLabel = `${b.brand}`.toLowerCase();
    const typesLabel = b.items.map(x => x.teaType).join(" ").toLowerCase();
    const match = !q || brandLabel.includes(q) || typesLabel.includes(q);
    if (!match) return;

    const opt = document.createElement("option");
    opt.value = `brand:${b.brandId}`;
    opt.textContent = `${b.brand}`;
    teaSelect.appendChild(opt);
  });

  // Ø­Ø§ÙˆÙ„ ØªØ±Ø¬Ø¹ Ù†ÙØ³ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ Ù…Ø§ Ø²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯
  const stillExists = Array.from(teaSelect.options).some(o => o.value === current);
  if (stillExists) {
    teaSelect.value = current;
  } else if (teaSelect.options.length) {
    teaSelect.value = teaSelect.options[0].value;
  }
}

function getSelectedTeaObject(){
  const val = teaSelect.value || "";
  const taste = tasteSel.value;

  // Ø´Ø§ÙŠ Ø¹Ø§Ø¯ÙŠ
  if (val.startsWith("simple:")) {
    const id = val.replace("simple:", "");
    const tea = SIMPLE_TEAS.find(x => x.id === id) || SIMPLE_TEAS[0];

    typeWrap.style.display = "none";

    const teaPerLiterPicked = pickRangeByTaste(tea.teaPerLiter, taste);
    return {
      brandLabel: tea.brand,
      teaType: tea.teaType,
      teaPerLiterPicked,
      sugarPerLiterPicked: (taste === "nosugar") ? 0 : pickRangeByTaste(tea.sugarPerLiter, taste),
      steepMinutes: tea.steepMinutes,
      hintText: `Ù„ÙƒÙ„ 1 Ù„ØªØ±: Ù…Ù†Ø§Ø³Ø¨ (Ø´Ø§ÙŠ ${smartNumber(tea.teaPerLiter.min)} â€¢ Ø³ÙƒØ± ${smartNumber(tea.sugarPerLiter.min)}) â€” Ø«Ù‚ÙŠÙ„ (Ø´Ø§ÙŠ ${smartNumber(tea.teaPerLiter.max)} â€¢ Ø³ÙƒØ± ${smartNumber(tea.sugarPerLiter.max)})`
    };
  }

  // Ø¨Ø±Ø§Ù†Ø¯ Ø¨ØªØµÙ†ÙŠÙØ§Øª
  if (val.startsWith("brand:")) {
    const brandId = val.replace("brand:", "");
    const brand = BRANDED_TEAS.find(b => b.brandId === brandId) || BRANDED_TEAS[0];

    typeWrap.style.display = "block";

    // Ø¹Ø¨ÙŠ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø¥Ø°Ø§ ÙØ§Ø¶ÙŠØ© Ø£Ùˆ Ù„Ùˆ ØªØºÙŠØ± Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯
    const existingIds = Array.from(typeSelect.options).map(o => o.value);
    const shouldRebuild = existingIds.length !== brand.items.length ||
      (existingIds[0] && !brand.items.some(it => it.id === existingIds[0]));

    if (shouldRebuild) {
      typeSelect.innerHTML = "";
      brand.items.forEach(it => {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.teaType;
        typeSelect.appendChild(opt);
      });
      typeSelect.value = brand.items[0].id;
    }

    const selectedItem = brand.items.find(it => it.id === typeSelect.value) || brand.items[0];

    const teaPerLiterPicked = selectedItem.teaPerLiterByTaste
      ? Number(selectedItem.teaPerLiterByTaste[taste])
      : pickRangeByTaste(selectedItem.teaPerLiter, taste);

    const sugarPerLiterPicked = (taste === "nosugar") ? 0 : pickRangeByTaste(selectedItem.sugarPerLiter, taste);

    const hint = selectedItem.teaPerLiterByTaste
      ? `Ù„ÙƒÙ„ 1 Ù„ØªØ±: Ù…Ù†Ø§Ø³Ø¨ (Ø´Ø§ÙŠ ${smartNumber(selectedItem.teaPerLiterByTaste.normal)} â€¢ Ø³ÙƒØ± ${smartNumber(selectedItem.sugarPerLiter.min)}) â€” Ø«Ù‚ÙŠÙ„ (Ø´Ø§ÙŠ ${smartNumber(selectedItem.teaPerLiterByTaste.heavy)} â€¢ Ø³ÙƒØ± ${smartNumber(selectedItem.sugarPerLiter.max)}) â€” Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ± (Ø´Ø§ÙŠ ${smartNumber(selectedItem.teaPerLiterByTaste.nosugar)} â€¢ Ø³ÙƒØ± 0)`
      : `Ù„ÙƒÙ„ 1 Ù„ØªØ±: Ù…Ù†Ø§Ø³Ø¨ (Ø´Ø§ÙŠ ${smartNumber(selectedItem.teaPerLiter.min)} â€¢ Ø³ÙƒØ± ${smartNumber(selectedItem.sugarPerLiter.min)}) â€” Ø«Ù‚ÙŠÙ„ (Ø´Ø§ÙŠ ${smartNumber(selectedItem.teaPerLiter.max)} â€¢ Ø³ÙƒØ± ${smartNumber(selectedItem.sugarPerLiter.max)})`;

    return {
      brandLabel: brand.brand,
      teaType: selectedItem.teaType,
      teaPerLiterPicked,
      sugarPerLiterPicked,
      steepMinutes: selectedItem.steepMinutes,
      hintText: hint
    };
  }

  // fallback
  typeWrap.style.display = "none";
  const t = SIMPLE_TEAS[0];
  return {
    brandLabel: t.brand,
    teaType: t.teaType,
    teaPerLiterPicked: pickRangeByTaste(t.teaPerLiter, tasteSel.value),
    sugarPerLiterPicked: (tasteSel.value === "nosugar") ? 0 : pickRangeByTaste(t.sugarPerLiter, tasteSel.value),
    steepMinutes: t.steepMinutes,
    hintText: ""
  };
}

function getResultText(){
  const liters = toLitersFromMl(waterMlInp.value);
  if (!Number.isFinite(liters)) return "";

  const teaObj = getSelectedTeaObject();
  const tasteText = tasteLabel(tasteSel.value);

  const teaGrams = smartNumber(teaObj.teaPerLiterPicked * liters);
  const sugarText = teaObj.sugarPerLiterPicked === 0 ? "Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±" : (smartNumber(teaObj.sugarPerLiterPicked * liters) + " Ø¬Ù…");

  const cups = Number(waterMlInp.value) / CUP_ML;

  return `
Ø´Ø§ÙŠ ${teaObj.brandLabel} â€” ${teaObj.teaType}
Ø§Ù„Ù…Ø§Ø¡: ${waterMlInp.value} Ù…Ù„
Ø§Ù„Ù…Ø°Ø§Ù‚: ${tasteText}

ÙˆØ²Ù† Ø§Ù„Ø´Ø§ÙŠ: ${teaGrams} Ø¬Ù…
Ø§Ù„Ø³ÙƒØ±: ${sugarText}
Ù…Ø¯Ø© Ø§Ù„Ø®Ø¯Ø±Ø©: ${minutesText(teaObj.steepMinutes)}
ÙƒÙ… Ø¨ÙŠØ§Ù„Ø© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹: ${smartNumber(cups)}
`.trim();
}

function bindActionButtons(){
  const copyBtn = document.getElementById("copyBtn");
  const waBtn = document.getElementById("waBtn");

  if (copyBtn) {
    copyBtn.onclick = async () => {
      const text = getResultText();
      if (!text) return;

      try {
        await navigator.clipboard.writeText(text);
      } catch (e) {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }

      copyBtn.textContent = "ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ“";
      setTimeout(() => copyBtn.textContent = "Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©", 1500);
    };
  }

  if (waBtn) {
    waBtn.onclick = () => {
      const text = encodeURIComponent(getResultText());
      if (!text) return;
      window.location.href = `https://wa.me/?text=${text}`;
    };
  }
}

function render(){
  try {
    const liters = toLitersFromMl(waterMlInp.value);
    if (!Number.isFinite(liters)) {
      output.innerHTML = `<div class="error-panel">âš ï¸ Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© Ù…Ø§Ø¡ ØµØ­ÙŠØ­Ø© Ø¨Ø§Ù„Ù…Ù„.</div>`;
      return;
    }

    const teaObj = getSelectedTeaObject();
    const taste = tasteSel.value;

    tasteHint.textContent = teaObj.hintText;

    const teaGrams = teaObj.teaPerLiterPicked * liters;
    const sugarGrams = teaObj.sugarPerLiterPicked === 0 ? 0 : (teaObj.sugarPerLiterPicked * liters);

    const waterMl = Number(waterMlInp.value);
    const cups = (Number.isFinite(waterMl) && waterMl > 0) ? (waterMl / CUP_ML) : NaN;

    const sugarText = (teaObj.sugarPerLiterPicked === 0) ? "Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±" : `${smartNumber(sugarGrams)} Ø¬Ù…`;

    output.innerHTML = `
      <div class="kpi">
        <div class="box">
          <div class="muted"><i data-lucide="scale"></i> ÙˆØ²Ù† Ø§Ù„Ø´Ø§ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div>
          <div class="big">${smartNumber(teaGrams)} Ø¬Ù…</div>
          <div class="muted2">${tasteLabel(taste)} â€¢ Ù„ÙƒÙ„ Ù„ØªØ±: ${smartNumber(teaObj.teaPerLiterPicked)} Ø¬Ù…</div>
        </div>

        <div class="box">
          <div class="muted"><i data-lucide="candy"></i> Ø§Ù„Ø³ÙƒØ±</div>
          <div class="big">${sugarText}</div>
          <div class="muted2">${taste === "nosugar" ? "Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±" : `Ù„ÙƒÙ„ Ù„ØªØ±: ${smartNumber(teaObj.sugarPerLiterPicked)} Ø¬Ù…`}</div>
        </div>

        <div class="box">
          <div class="muted"><i data-lucide="clock"></i> Ù…Ø¯Ø© Ø§Ù„Ø®Ø¯Ø±Ø©</div>
          <div class="big">${minutesText(teaObj.steepMinutes)}</div>
        </div>

        <div class="box">
          <div class="muted"><i data-lucide="coffee"></i> ÙƒÙ… Ø¨ÙŠØ§Ù„Ø© ØªÙƒÙÙŠ (ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹)</div>
          <div class="big">${smartNumber(cups)}</div>
          <div class="muted2">Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù„Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ Ù¡Ù Ù  Ù…Ù„</div>
        </div>
      </div>

      <div class="actions">
        <button id="copyBtn" class="actionBtn">Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        <button id="waBtn" class="actionBtn">Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
      </div>

      <div class="note">
        <b>Ø§Ù„Ù…Ù†ØªØ¬:</b> ${teaObj.brandLabel} â€” ${teaObj.teaType}<br/>
        <b>Ø§Ù„Ù…Ø°Ø§Ù‚:</b> ${tasteLabel(taste)}<br/>
        <b>Ø§Ù„Ù…Ø§Ø¡:</b> ${waterMlInp.value} Ù…Ù„
      </div>
    `;

    if (window.lucide) lucide.createIcons();
    bindActionButtons();
  } catch (e) {
    output.innerHTML = `
      <div class="error-panel">
        âš ï¸ ØµØ§Ø± Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§ÙŠ (Ù‚ÙˆØ³/ÙØ§ØµÙ„Ø©/Ù‚ÙŠÙ…Ø©).
        <div style="opacity:.8;font-size:12px;margin-top:6px">ØªÙØ§ØµÙŠÙ„: ${String(e.message || e)}</div>
      </div>
    `;
  }
}

/* events */
teaSearch.addEventListener("input", () => {
  populateMainSelect(teaSearch.value);
  render();
});

teaSelect.addEventListener("change", render);
typeSelect.addEventListener("change", render);
waterMlInp.addEventListener("input", render);
tasteSel.addEventListener("change", render);

/* init */
populateMainSelect("");
render();

</script>
</body>
</html>
