<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <link rel="apple-touch-icon" href="icon.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø´Ø§ÙŠ</title>

  <!-- Lucide icons (outline) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root { 
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      --primary-bg: #0b1220;
      --card-bg: rgba(255,255,255,0.06);
      --card-border: rgba(255,255,255,0.10);
      --text-primary: #e9eefc;
      --text-secondary: rgba(233,238,252,0.75);
      --input-bg: rgba(0,0,0,0.25);
      --input-border: rgba(255,255,255,0.16);
      --error-bg: rgba(255,80,80,.10);
      --error-border: rgba(255,80,80,.35);
    }

    * { box-sizing: border-box; }
    
    body { 
      margin: 0; 
      background: var(--primary-bg); 
      color: var(--text-primary);
      padding: 16px;
    }

    .wrap { 
      max-width: 1400px; 
      margin: 0 auto;
    }

    .header {
      margin-bottom: 24px;
      text-align: center;
    }

    .header h1 {
      margin: 0 0 6px;
      font-size: 24px;
      font-weight: 600;
    }

    .header .sub {
      margin: 0;
      opacity: 0.75;
      font-size: 14px;
    }

    .layout {
      display: grid;
      gap: 20px;
      grid-template-columns: 1fr;
    }

    @media (min-width: 1024px) {
      .layout {
        grid-template-columns: 1fr 1fr;
      }
    }

    .panel {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 24px;
      backdrop-filter: blur(8px);
    }

    .panel-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 18px;
      opacity: 0.95;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title svg {
      width: 18px;
      height: 18px;
      stroke-width: 1.8;
    }

    .input-group {
      margin-bottom: 16px;
    }

    .input-group:last-child {
      margin-bottom: 0;
    }

    label {
      font-size: 13px;
      opacity: 0.9;
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
    }

    select, input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none;
      font-size: 15px;
      height: 48px;
      transition: border-color 0.2s, background-color 0.2s;
    }

    select:focus, input:focus {
      border-color: rgba(255,255,255,0.25);
      background: rgba(0,0,0,0.35);
    }

    input[type=number] { 
      appearance: textfield; 
      -moz-appearance: textfield; 
    }

    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }

    /* ğŸ”§ Fix: Dark text on light dropdown for desktop readability */
    select option { 
      color: #1a1a1a; 
      background: #f5f5f5;
      padding: 4px 8px;
    }

    select option:checked {
      background: #e0e0e0;
      color: #000;
    }

    input::placeholder { 
      opacity: 0.6; 
      color: var(--text-secondary);
    }

    .helper-text {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 6px;
      line-height: 1.4;
    }

    /* Results Panel */
    .kpi-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr;
    }

    @media (min-width: 768px) {
      .kpi-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .kpi-box {
      padding: 16px;
      border-radius: 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--card-border);
      transition: background-color 0.2s;
    }

    .kpi-box:hover {
      background: rgba(255,255,255,0.08);
    }

    .kpi-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      opacity: 0.75;
      margin-bottom: 8px;
    }

    .kpi-label svg {
      width: 16px;
      height: 16px;
      stroke-width: 1.7;
    }

    .kpi-value {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 6px;
      line-height: 1.2;
    }

    .kpi-note {
      font-size: 12px;
      opacity: 0.65;
      line-height: 1.3;
    }

    .summary-box {
      margin-top: 16px;
      padding: 14px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.6;
      opacity: 0.85;
    }

    .summary-box b {
      font-weight: 600;
      opacity: 0.95;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .action-btn {
      flex: 1;
      min-width: 140px;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .action-btn:hover {
      background: rgba(255,255,255,0.15);
      border-color: rgba(255,255,255,0.3);
    }

    .action-btn:active {
      transform: scale(0.98);
    }

    .action-btn svg {
      width: 14px;
      height: 14px;
      stroke-width: 2;
    }

    /* Error State */
    .error-panel {
      padding: 14px;
      border-radius: 12px;
      border: 1px solid var(--error-border);
      background: var(--error-bg);
      color: #ff9999;
    }

    .error-panel .error-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .error-panel .error-detail {
      font-size: 12px;
      opacity: 0.8;
      word-break: break-word;
    }

    /* Loading / Empty State */
    .empty-state {
      text-align: center;
      padding: 24px;
      opacity: 0.6;
      font-size: 14px;
    }

    .empty-state svg {
      width: 32px;
      height: 32px;
      margin-bottom: 12px;
      opacity: 0.4;
    }

    @media (max-width: 1023px) {
      .panel {
        padding: 18px;
      }

      .layout {
        gap: 16px;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Header -->
    <div class="header">
      <h1>â˜• Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø´Ø§ÙŠ</h1>
      <p class="sub">Ø§Ø­Ø³Ø¨ ÙˆØ²Ù† Ø§Ù„Ø´Ø§ÙŠ ÙˆØ§Ù„Ø³ÙƒØ± ÙˆÙ…Ø¯Ø© Ø§Ù„Ø®Ø¯Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªÙØ¶ÙŠÙ„Ø§ØªÙƒ</p>
    </div>

    <!-- Two-Column Layout: Inputs | Results -->
    <div class="layout">
      <!-- LEFT PANEL: Inputs -->
      <div class="panel">
        <div class="panel-title">
          <i data-lucide="sliders-horizontal"></i>
          Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        </div>

        <!-- Search Input -->
        <div class="input-group">
          <label>ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø§ÙŠ</label>
          <input 
            id="teaSearch" 
            type="text" 
            placeholder="Ø§Ù„Ù…Ù†ÙŠØ³ â€¢ Ù†Ù‡Ø±ÙŠÙ† â€¢ OP1 â€¢ BOP..." 
          />
          <div class="helper-text">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯ Ø£Ùˆ Ù†ÙˆØ¹ Ø§Ù„ÙˆØ±Ù‚ Ù„Ù„ÙÙ„ØªØ±Ø©</div>
        </div>

        <!-- Main Tea Select -->
        <div class="input-group">
          <label>Ø§Ø®ØªØ± Ø§Ù„Ø´Ø§ÙŠ</label>
          <select id="teaSelect"></select>
          <div class="helper-text" id="teaHint"></div>
        </div>

        <!-- Tea Type (appears only for branded teas with multiple types) -->
        <div id="typeWrap" style="display:none;" class="input-group">
          <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ±Ù‚</label>
          <select id="typeSelect"></select>
          <div class="helper-text">ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø¨Ø±Ø§Ù†Ø¯Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ Ø¹Ø¯Ø© Ø£Ù†ÙˆØ§Ø¹</div>
        </div>

        <!-- Water Input -->
        <div class="input-group">
          <label>ğŸ’§ ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø§Ø¡ (Ù…Ù„)</label>
          <input 
            id="waterMl" 
            type="number" 
            inputmode="decimal" 
            min="1" 
            value="1000" 
          />
          <div class="helper-text">Ø£Ù…Ø«Ù„Ø©: 500 â€¢ 750 â€¢ 1000 â€¢ 1500 Ù…Ù„</div>
        </div>

        <!-- Taste Select -->
        <div class="input-group">
          <label>ğŸ‘… Ø§Ù„Ù…Ø°Ø§Ù‚ Ø§Ù„Ù…ÙØ¶Ù„</label>
          <select id="taste">
            <option value="normal" selected>Ù…Ù†Ø§Ø³Ø¨</option>
            <option value="heavy">Ø«Ù‚ÙŠÙ„</option>
            <option value="nosugar">Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±</option>
          </select>
          <div class="helper-text" id="tasteHint"></div>
        </div>
      </div>

      <!-- RIGHT PANEL: Results -->
      <div class="panel">
        <div class="panel-title">
          <i data-lucide="check-circle-2"></i>
          Ø§Ù„Ù†ØªÙŠØ¬Ø©
        </div>

        <div id="resultsContainer" aria-live="polite" aria-atomic="true">
          <div class="empty-state">
            <i data-lucide="loader"></i>
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   âœ… ÙˆÙŠÙ† ØªØ¶ÙŠÙ Ø§Ù„Ø´Ø§ÙŠØŸ
   
   1ï¸âƒ£ Ø´Ø§ÙŠ Ø¹Ø§Ø¯ÙŠ (Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙØ§Øª):
      Ø£Ø¶ÙÙ‡ ÙÙŠ SIMPLE_TEAS Ù…Ø¹:
      - id: Ù…Ø¹Ø±Ù‘Ù ÙØ±ÙŠØ¯
      - brand: Ø§Ø³Ù… Ø§Ù„Ø´Ø§ÙŠ
      - teaType: Ù†ÙˆØ¹ Ø§Ù„ÙˆØ±Ù‚ (OP, OP1, BOP, Ø¥Ù„Ø®)
      - teaPerLiter: {min, max} ÙˆØ²Ù† Ø§Ù„Ø´Ø§ÙŠ Ù„ÙƒÙ„ Ù„ØªØ±
      - sugarPerLiter: {min, max} Ø§Ù„Ø³ÙƒØ± Ù„ÙƒÙ„ Ù„ØªØ±
      - steepMinutes: {min, max} Ù…Ø¯Ø© Ø§Ù„Ø®Ø¯Ø±Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚

   2ï¸âƒ£ Ø´Ø§ÙŠ Ø¨ØªØµÙ†ÙŠÙØ§Øª (Ù…Ø«Ù„ Ø§Ù„Ù…Ù†ÙŠØ³):
      Ø£Ø¶ÙÙ‡ ÙÙŠ BRANDED_TEAS Ù…Ø¹:
      - brandId: Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯ Ø§Ù„ÙØ±ÙŠØ¯
      - brand: Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯
      - items: Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ (OP1, BOP1, Ø¥Ù„Ø®)
        - Ù„ÙƒÙ„ Ù†ÙˆØ¹: id, teaType, ÙˆØ¥Ù…Ø§:
          * teaPerLiterByTaste: {normal, heavy, nosugar}
          * Ø£Ùˆ teaPerLiter: {min, max}
        - sugarPerLiter: {min, max}
        - steepMinutes: {min, max}
   ========================= */

/* ---------- (A) Ø§Ù„Ø´Ø§ÙŠ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©) ---------- */
const SIMPLE_TEAS = [
  {
    id: "nahrain-op",
    teaType: "OP",
    brand: "Ø´Ø§ÙŠ Ø§Ù„Ù†Ù‡Ø±ÙŠÙ†",
    teaPerLiter:   { min: 12, max: 12 },
    sugarPerLiter: { min: 50, max: 55 },
    steepMinutes:  { min: 20, max: 25 }
  },
  {
    id: "naif-op1",
    teaType: "OP1",
    brand: "Ø´Ø§ÙŠ Ù†Ø§ÙŠÙ",
    teaPerLiter:   { min: 14, max: 14 },
    sugarPerLiter: { min: 50, max: 55 },
    steepMinutes:  { min: 30, max: 35 }
  }
  // ğŸ‘‡ Ø£Ø¶Ù Ø´Ø§ÙŠÙƒ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù‡Ù†Ø§ (Ø§Ù†Ø³Ø® Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù†Ù‡Ø±ÙŠÙ† ÙˆØ¹Ø¯Ù‘Ù„)
];

/* ---------- (B) Ø´Ø§ÙŠ Ø¨ØªØµÙ†ÙŠÙØ§Øª (Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯ Ø§Ù„ÙˆØ§Ø­Ø¯ Ù„Ù‡ Ø¹Ø¯Ø© Ø£Ù†ÙˆØ§Ø¹) ---------- */
const BRANDED_TEAS = [
  {
    brandId: "munais",
    brand: "Ø´Ø§ÙŠ Ø§Ù„Ù…Ù†ÙŠØ³",
    items: [
      {
        id: "munais-op1",
        teaType: "OP1",
        // âœ… ØªØ¹Ø±ÙŠÙ Ø¯Ù‚ÙŠÙ‚: Ù„ÙƒÙ„ Ù…Ø°Ø§Ù‚ Ù‚ÙŠÙ…Ø© Ù…Ø®ØªÙ„ÙØ© Ù…Ù† Ø§Ù„Ø´Ø§ÙŠ
        teaPerLiterByTaste: { normal: 12.5, heavy: 13.5, nosugar: 11.5 },
        sugarPerLiter: { min: 50, max: 55 },
        steepMinutes: { min: 25, max: 30 }
      },
      {
        id: "munais-bop1",
        teaType: "BOP1",
        teaPerLiterByTaste: { normal: 13, heavy: 14, nosugar: 12 },
        sugarPerLiter: { min: 50, max: 55 },
        steepMinutes: { min: 25, max: 30 }
      },
      {
        id: "munais-fbop1",
        teaType: "FBOP1",
        teaPerLiterByTaste: { normal: 14, heavy: 15, nosugar: 13 },
        sugarPerLiter: { min: 50, max: 55 },
        steepMinutes: { min: 20, max: 25 }
      }
    ]
  }
  // ğŸ‘‡ Ø£Ø¶Ù Ø¨Ø±Ø§Ù†Ø¯Ùƒ Ø¨ØªØµÙ†ÙŠÙØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù‡Ù†Ø§ (Ø§Ù†Ø³Ø® Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ù†ÙŠØ³ ÙˆØ¹Ø¯Ù‘Ù„)
];

/* Ø§ÙØªØ±Ø§Ø¶ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù„Ø© */
const CUP_ML = 100;

/* ===== Helper Functions ===== */
function smartNumber(n) {
  if (!Number.isFinite(n)) return "-";
  const isInt = Math.abs(n - Math.round(n)) < 1e-9;
  return isInt ? String(Math.round(n)) : n.toFixed(1);
}

function toLitersFromMl(ml) {
  const v = Number(ml);
  if (!Number.isFinite(v) || v <= 0) return NaN;
  return v / 1000;
}

function minutesText(r) {
  if (r.min === r.max) return `${r.min} Ø¯Ù‚ÙŠÙ‚Ø©`;
  return `${r.min} â€“ ${r.max} Ø¯Ù‚ÙŠÙ‚Ø©`;
}

function pickRangeByTaste(range, taste) {
  if (taste === "heavy") return range.max;
  return range.min; // Ù…Ù†Ø§Ø³Ø¨ + Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ± => Ø§Ù„Ø£Ù‚Ù„
}

function tasteLabel(v) {
  if (v === "heavy") return "Ø«Ù‚ÙŠÙ„";
  if (v === "nosugar") return "Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±";
  return "Ù…Ù†Ø§Ø³Ø¨";
}

function tasteEmoji(v) {
  if (v === "heavy") return "ğŸ”¥";
  if (v === "nosugar") return "â˜•";
  return "â˜•";
}

/* ===== DOM References ===== */
const teaSearch        = document.getElementById("teaSearch");
const teaSelect        = document.getElementById("teaSelect");
const teaHint          = document.getElementById("teaHint");
const typeWrap         = document.getElementById("typeWrap");
const typeSelect       = document.getElementById("typeSelect");
const waterMlInp       = document.getElementById("waterMl");
const tasteSel         = document.getElementById("taste");
const tasteHint        = document.getElementById("tasteHint");
const resultsContainer = document.getElementById("resultsContainer");

/* ===== Populate Main Tea Select (with search filtering) ===== */
function populateMainSelect(filterText = "") {
  const q = (filterText || "").trim().toLowerCase();
  const current = teaSelect.value;

  teaSelect.innerHTML = "";

  // SIMPLE_TEAS: individual entries
  SIMPLE_TEAS.forEach(t => {
    const label = `${t.brand} â€” ${t.teaType}`.toLowerCase();
    if (q && !label.includes(q)) return;

    const opt = document.createElement("option");
    opt.value = `simple:${t.id}`;
    opt.textContent = `${t.brand} â€” ${t.teaType}`;
    teaSelect.appendChild(opt);
  });

  // BRANDED_TEAS: brand entries (with optional type filter)
  BRANDED_TEAS.forEach(b => {
    const brandLabel = `${b.brand}`.toLowerCase();
    const typesLabel = b.items.map(x => x.teaType).join(" ").toLowerCase();
    const match = !q || brandLabel.includes(q) || typesLabel.includes(q);
    if (!match) return;

    const opt = document.createElement("option");
    opt.value = `brand:${b.brandId}`;
    opt.textContent = `${b.brand}`;
    teaSelect.appendChild(opt);
  });

  // Restore previous selection if it still exists
  const stillExists = Array.from(teaSelect.options).some(o => o.value === current);
  if (stillExists) {
    teaSelect.value = current;
  } else if (teaSelect.options.length) {
    teaSelect.value = teaSelect.options[0].value;
  }
}

/* ===== Get Selected Tea Configuration ===== */
function getSelectedTeaObject() {
  const val = teaSelect.value || "";
  const taste = tasteSel.value;

  // SIMPLE TEA
  if (val.startsWith("simple:")) {
    const id = val.replace("simple:", "");
    const tea = SIMPLE_TEAS.find(x => x.id === id) || SIMPLE_TEAS[0];

    typeWrap.style.display = "none";

    const teaPerLiterPicked = pickRangeByTaste(tea.teaPerLiter, taste);
    const sugarPerLiterPicked = (taste === "nosugar") ? 0 : pickRangeByTaste(tea.sugarPerLiter, taste);

    return {
      brandLabel: tea.brand,
      teaType: tea.teaType,
      teaPerLiterPicked,
      sugarPerLiterPicked,
      steepMinutes: tea.steepMinutes,
      hintText: `Ù„ÙƒÙ„ 1 Ù„ØªØ±: Ù…Ù†Ø§Ø³Ø¨ (Ø´Ø§ÙŠ ${smartNumber(tea.teaPerLiter.min)}Ø¬Ù… â€¢ Ø³ÙƒØ± ${smartNumber(tea.sugarPerLiter.min)}Ø¬Ù…) â€” Ø«Ù‚ÙŠÙ„ (Ø´Ø§ÙŠ ${smartNumber(tea.teaPerLiter.max)}Ø¬Ù… â€¢ Ø³ÙƒØ± ${smartNumber(tea.sugarPerLiter.max)}Ø¬Ù…)`
    };
  }

  // BRANDED TEA WITH TYPES
  if (val.startsWith("brand:")) {
    const brandId = val.replace("brand:", "");
    const brand = BRANDED_TEAS.find(b => b.brandId === brandId) || BRANDED_TEAS[0];

    typeWrap.style.display = "block";

    // Rebuild type dropdown if brand changed or it's empty
    const existingIds = Array.from(typeSelect.options).map(o => o.value);
    const shouldRebuild = existingIds.length !== brand.items.length ||
      (existingIds[0] && !brand.items.some(it => it.id === existingIds[0]));

    if (shouldRebuild) {
      typeSelect.innerHTML = "";
      brand.items.forEach(it => {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.teaType;
        typeSelect.appendChild(opt);
      });
      typeSelect.value = brand.items[0].id;
    }

    const selectedItem = brand.items.find(it => it.id === typeSelect.value) || brand.items[0];

    // Determine tea weight: if teaPerLiterByTaste exists, use exact mapping; else use range
    const teaPerLiterPicked = selectedItem.teaPerLiterByTaste
      ? Number(selectedItem.teaPerLiterByTaste[taste])
      : pickRangeByTaste(selectedItem.teaPerLiter, taste);

    const sugarPerLiterPicked = (taste === "nosugar") ? 0 : pickRangeByTaste(selectedItem.sugarPerLiter, taste);

    // Build hint text
    let hintText = "";
    if (selectedItem.teaPerLiterByTaste) {
      hintText = `Ù„ÙƒÙ„ 1 Ù„ØªØ±: Ù…Ù†Ø§Ø³Ø¨ (${smartNumber(selectedItem.teaPerLiterByTaste.normal)}Ø¬Ù…) â€” Ø«Ù‚ÙŠÙ„ (${smartNumber(selectedItem.teaPerLiterByTaste.heavy)}Ø¬Ù…) â€” Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ± (${smartNumber(selectedItem.teaPerLiterByTaste.nosugar)}Ø¬Ù…)`;
    } else if (selectedItem.teaPerLiter) {
      hintText = `Ù„ÙƒÙ„ 1 Ù„ØªØ±: Ù…Ù†Ø§Ø³Ø¨ (${smartNumber(selectedItem.teaPerLiter.min)}Ø¬Ù…) â€” Ø«Ù‚ÙŠÙ„ (${smartNumber(selectedItem.teaPerLiter.max)}Ø¬Ù…)`;
    }

    return {
      brandLabel: brand.brand,
      teaType: selectedItem.teaType,
      teaPerLiterPicked,
      sugarPerLiterPicked,
      steepMinutes: selectedItem.steepMinutes,
      hintText
    };
  }

  // Fallback
  typeWrap.style.display = "none";
  const t = SIMPLE_TEAS[0];
  return {
    brandLabel: t.brand,
    teaType: t.teaType,
    teaPerLiterPicked: pickRangeByTaste(t.teaPerLiter, tasteSel.value),
    sugarPerLiterPicked: (tasteSel.value === "nosugar") ? 0 : pickRangeByTaste(t.sugarPerLiter, tasteSel.value),
    steepMinutes: t.steepMinutes,
    hintText: ""
  };
}

/* ===== Generate Clean Result Text (for copy/share) ===== */
function getResultText() {
  const liters = toLitersFromMl(waterMlInp.value);
  if (!Number.isFinite(liters)) return "";

  const teaObj = getSelectedTeaObject();
  const tasteText = tasteLabel(tasteSel.value);

  const teaGrams = smartNumber(teaObj.teaPerLiterPicked * liters);
  const sugarText = teaObj.sugarPerLiterPicked === 0 ? "Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±" : (smartNumber(teaObj.sugarPerLiterPicked * liters) + " Ø¬Ù…");

  const cups = Number(waterMlInp.value) / CUP_ML;

  return `
â˜• Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø´Ø§ÙŠ

Ø§Ù„Ù…Ù†ØªØ¬: ${teaObj.brandLabel} â€” ${teaObj.teaType}
Ø§Ù„Ù…Ø§Ø¡: ${waterMlInp.value} Ù…Ù„
Ø§Ù„Ù…Ø°Ø§Ù‚: ${tasteText}

ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬:
ÙˆØ²Ù† Ø§Ù„Ø´Ø§ÙŠ: ${teaGrams} Ø¬Ù…
Ø§Ù„Ø³ÙƒØ±: ${sugarText}
Ù…Ø¯Ø© Ø§Ù„Ø®Ø¯Ø±Ø©: ${minutesText(teaObj.steepMinutes)}
Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù„Ø§Øª (ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹): ${smartNumber(cups)}
  `.trim();
}

/* ===== Bind Action Buttons (must run after render to capture new IDs) ===== */
function bindActionButtons() {
  const copyBtn = document.getElementById("copyBtn");
  const waBtn = document.getElementById("waBtn");

  if (copyBtn) {
    copyBtn.onclick = async (e) => {
      e.preventDefault();
      const text = getResultText();
      if (!text) return;

      try {
        await navigator.clipboard.writeText(text);
      } catch (err) {
        // Fallback for older browsers
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }

      const originalText = copyBtn.textContent;
      copyBtn.textContent = "âœ“ ØªÙ… Ø§Ù„Ù†Ø³Ø®";
      setTimeout(() => {
        copyBtn.textContent = originalText;
      }, 1500);
    };
  }

  if (waBtn) {
    waBtn.onclick = (e) => {
      e.preventDefault();
      const text = encodeURIComponent(getResultText());
      if (!text) return;
      window.open(`https://wa.me/?text=${text}`, "_blank");
    };
  }
}

/* ===== Main Render Function ===== */
function render() {
  try {
    const liters = toLitersFromMl(waterMlInp.value);
    
    if (!Number.isFinite(liters)) {
      resultsContainer.innerHTML = `
        <div class="error-panel">
          <div class="error-title">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</div>
          <div class="error-detail">Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© Ù…Ø§Ø¡ ØµØ­ÙŠØ­Ø© Ø¨Ø§Ù„Ù…Ù„ (Ø£ÙƒØ¨Ø± Ù…Ù† 0)</div>
        </div>
      `;
      return;
    }

    const teaObj = getSelectedTeaObject();
    const taste = tasteSel.value;

    // Update taste hint
    teaHint.textContent = teaObj.hintText;
    teaHint.style.display = teaObj.hintText ? "block" : "none";

    // Calculate values
    const teaGrams = teaObj.teaPerLiterPicked * liters;
    const sugarGrams = teaObj.sugarPerLiterPicked === 0 ? 0 : (teaObj.sugarPerLiterPicked * liters);
    const waterMl = Number(waterMlInp.value);
    const cups = (Number.isFinite(waterMl) && waterMl > 0) ? (waterMl / CUP_ML) : NaN;
    const sugarText = (teaObj.sugarPerLiterPicked === 0) ? "Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±" : `${smartNumber(sugarGrams)} Ø¬Ù…`;

    // Render KPI Grid + Action Buttons + Summary
    resultsContainer.innerHTML = `
      <div class="kpi-grid">
        <!-- KPI 1: Tea Weight -->
        <div class="kpi-box">
          <div class="kpi-label">
            <i data-lucide="weight"></i>
            ÙˆØ²Ù† Ø§Ù„Ø´Ø§ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
          </div>
          <div class="kpi-value">${smartNumber(teaGrams)} <span style="font-size: 0.5em; opacity: 0.7;">Ø¬Ù…</span></div>
          <div class="kpi-note">${tasteLabel(taste)} â€¢ ${smartNumber(teaObj.teaPerLiterPicked)} Ø¬Ù…/Ù„ØªØ±</div>
        </div>

        <!-- KPI 2: Sugar -->
        <div class="kpi-box">
          <div class="kpi-label">
            <i data-lucide="candy"></i>
            Ø§Ù„Ø³ÙƒØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
          </div>
          <div class="kpi-value">${sugarText}</div>
          <div class="kpi-note">${taste === "nosugar" ? "Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ©" : `${smartNumber(teaObj.sugarPerLiterPicked)} Ø¬Ù…/Ù„ØªØ±`}</div>
        </div>

        <!-- KPI 3: Steep Time -->
        <div class="kpi-box">
          <div class="kpi-label">
            <i data-lucide="clock"></i>
            Ù…Ø¯Ø© Ø§Ù„Ø®Ø¯Ø±Ø©
          </div>
          <div class="kpi-value">${minutesText(teaObj.steepMinutes)}</div>
          <div class="kpi-note">Ø§ØªØ±ÙƒÙ‡ ÙÙŠ Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„Ø³Ø§Ø®Ù† Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª</div>
        </div>

        <!-- KPI 4: Cups Count -->
        <div class="kpi-box">
          <div class="kpi-label">
            <i data-lucide="cup"></i>
            Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù„Ø§Øª
          </div>
          <div class="kpi-value">${smartNumber(cups)} <span style="font-size: 0.5em; opacity: 0.7;">ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹</span></div>
          <div class="kpi-note">Ø§Ù„Ø¨ÙŠØ§Ù„Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© â‰ˆ 100 Ù…Ù„</div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button id="copyBtn" class="action-btn">
          <i data-lucide="copy"></i>
          Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©
        </button>
        <button id="waBtn" class="action-btn">
          <i data-lucide="send"></i>
          Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨
        </button>
      </div>

      <!-- Summary Box -->
      <div class="summary-box">
        <b>${teaObj.brandLabel} â€” ${teaObj.teaType}</b><br/>
        <b>Ø§Ù„Ù…Ø§Ø¡:</b> ${waterMl} Ù…Ù„ | 
        <b>Ø§Ù„Ù…Ø°Ø§Ù‚:</b> ${tasteLabel(taste)}
      </div>
    `;

    // Re-render Lucide icons for newly added DOM elements
    if (window.lucide) {
      lucide.createIcons();
    }

    // CRITICAL: Bind buttons AFTER they're added to DOM
    bindActionButtons();

  } catch (error) {
    resultsContainer.innerHTML = `
      <div class="error-panel">
        <div class="error-title">âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        <div class="error-detail">${String(error.message || error)}</div>
      </div>
    `;
  }
}

/* ===== Event Listeners ===== */
teaSearch.addEventListener("input", () => {
  populateMainSelect(teaSearch.value);
  render();
});

teaSelect.addEventListener("change", render);
typeSelect.addEventListener("change", render);
waterMlInp.addEventListener("input", render);
tasteSel.addEventListener("change", render);

/* ===== Initialize ===== */
populateMainSelect("");
render();

</script>
</body>
</html>
